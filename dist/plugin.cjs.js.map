{"version":3,"file":"plugin.cjs.js","sources":["esm/SupabaseConnector.js","esm/index.js","esm/web.js"],"sourcesContent":["import { BaseObserver, UpdateType, } from '@powersync/web';\nimport { createClient } from '@supabase/supabase-js';\nconst FATAL_RESPONSE_CODES = [\n    new RegExp('^22...$'),\n    new RegExp('^23...$'),\n    new RegExp('^42501$'),\n];\nexport class SupabaseConnector extends BaseObserver {\n    constructor(config) {\n        super();\n        this.config = config;\n        this.client = createClient(this.config.supabaseUrl, this.config.supabaseAnonKey, {\n            auth: {\n                persistSession: true,\n            },\n        });\n        this.currentSession = null;\n        this.ready = false;\n    }\n    async init() {\n        if (this.ready) {\n            return;\n        }\n        const sessionResponse = await this.client.auth.getSession();\n        this.updateSession(sessionResponse.data.session);\n        this.ready = true;\n        this.iterateListeners((cb) => { var _a; return (_a = cb.initialized) === null || _a === void 0 ? void 0 : _a.call(cb); });\n    }\n    async login(username, password) {\n        const { data: { session }, error, } = await this.client.auth.signInWithPassword({\n            email: username,\n            password: password,\n        });\n        if (error) {\n            throw error;\n        }\n        this.updateSession(session);\n    }\n    async signUp(email, password) {\n        const { data: { session }, error, } = await this.client.auth.signUp({\n            email,\n            password,\n        });\n        if (error) {\n            throw error;\n        }\n        this.updateSession(session);\n    }\n    async signOut() {\n        const { error } = await this.client.auth.signOut();\n        if (error) {\n            throw error;\n        }\n        this.currentSession = null;\n    }\n    getCurrentUser() {\n        var _a, _b;\n        return (_b = (_a = this.currentSession) === null || _a === void 0 ? void 0 : _a.user) !== null && _b !== void 0 ? _b : null;\n    }\n    getAccessToken() {\n        var _a, _b;\n        return (_b = (_a = this.currentSession) === null || _a === void 0 ? void 0 : _a.access_token) !== null && _b !== void 0 ? _b : null;\n    }\n    async fetchCredentials() {\n        var _a;\n        const { data: { session }, error, } = await this.client.auth.getSession();\n        if (!session || error) {\n            throw new Error(`Could not fetch Supabase credentials: ${error}`);\n        }\n        console.debug('session expires at', session.expires_at);\n        return {\n            endpoint: this.config.powersyncUrl,\n            token: (_a = session.access_token) !== null && _a !== void 0 ? _a : '',\n        };\n    }\n    async uploadData(database) {\n        const transaction = await database.getNextCrudTransaction();\n        if (!transaction) {\n            return;\n        }\n        let lastOp = null;\n        try {\n            for (const op of transaction.crud) {\n                lastOp = op;\n                const table = this.client.from(op.table);\n                let result;\n                switch (op.op) {\n                    case UpdateType.PUT: {\n                        const record = Object.assign(Object.assign({}, op.opData), { id: op.id });\n                        result = await table.upsert(record);\n                        break;\n                    }\n                    case UpdateType.PATCH: {\n                        result = await table.update(op.opData).eq('id', op.id);\n                        break;\n                    }\n                    case UpdateType.DELETE: {\n                        result = await table.delete().eq('id', op.id);\n                        break;\n                    }\n                }\n                if (result.error) {\n                    console.error(result.error);\n                    result.error.message = `Could not update Supabase. Received error: ${result.error.message}`;\n                    throw result.error;\n                }\n            }\n            await transaction.complete();\n        }\n        catch (ex) {\n            console.debug(ex);\n            if (typeof ex.code == 'string' && FATAL_RESPONSE_CODES.some((regex) => regex.test(ex.code))) {\n                console.error('Data upload error - discarding:', lastOp, ex);\n                await transaction.complete();\n            }\n            else {\n                throw ex;\n            }\n        }\n    }\n    updateSession(session) {\n        this.currentSession = session;\n        if (!session) {\n            return;\n        }\n        this.iterateListeners((cb) => { var _a; return (_a = cb.sessionStarted) === null || _a === void 0 ? void 0 : _a.call(cb, session); });\n    }\n}\n","import { registerPlugin } from '@capacitor/core';\nconst PowerSync = registerPlugin('BlueCortexPowerSyncSupabase', {\n    web: () => import('./web').then((m) => new m.BlueCortexPowerSyncSupabaseWeb()),\n});\nexport * from './definitions';\nexport { PowerSync };\nexport { SupabaseConnector } from './SupabaseConnector';\n","import { WebPlugin } from '@capacitor/core';\nexport class BlueCortexPowerSyncSupabaseWeb extends WebPlugin {\n    async initialize(options) {\n        console.log('PowerSync Web: initialize', options);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async connect() {\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async disconnect(options) {\n        console.log('PowerSync Web: disconnect', options);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async setToken(_options) {\n        console.log('PowerSync Web: setToken (no-op on web)');\n    }\n    async execute(options) {\n        console.log('PowerSync Web: execute', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async getAll(options) {\n        console.log('PowerSync Web: getAll', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async getOptional(options) {\n        console.log('PowerSync Web: getOptional', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async watch(options) {\n        console.log('PowerSync Web: watch', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async unwatch(options) {\n        console.log('PowerSync Web: unwatch', options.watchId);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async getSyncStatus() {\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async getVersion() {\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async writeTransaction(options) {\n        console.log('PowerSync Web: writeTransaction', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n}\n"],"names":["BaseObserver","createClient","UpdateType","registerPlugin","WebPlugin"],"mappings":"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"}