{"version":3,"file":"plugin.js","sources":["esm/SupabaseConnector.js","esm/index.js","esm/web.js"],"sourcesContent":["import { BaseObserver, UpdateType, } from '@powersync/web';\nimport { createClient } from '@supabase/supabase-js';\nconst FATAL_RESPONSE_CODES = [\n    new RegExp('^22...$'),\n    new RegExp('^23...$'),\n    new RegExp('^42501$'),\n];\nexport class SupabaseConnector extends BaseObserver {\n    constructor(config) {\n        super();\n        this.config = config;\n        this.client = createClient(this.config.supabaseUrl, this.config.supabaseAnonKey, {\n            auth: {\n                persistSession: true,\n            },\n        });\n        this.currentSession = null;\n        this.ready = false;\n    }\n    async init() {\n        if (this.ready) {\n            return;\n        }\n        const sessionResponse = await this.client.auth.getSession();\n        this.updateSession(sessionResponse.data.session);\n        this.ready = true;\n        this.iterateListeners((cb) => { var _a; return (_a = cb.initialized) === null || _a === void 0 ? void 0 : _a.call(cb); });\n    }\n    async login(username, password) {\n        const { data: { session }, error, } = await this.client.auth.signInWithPassword({\n            email: username,\n            password: password,\n        });\n        if (error) {\n            throw error;\n        }\n        this.updateSession(session);\n    }\n    async signUp(email, password) {\n        const { data: { session }, error, } = await this.client.auth.signUp({\n            email,\n            password,\n        });\n        if (error) {\n            throw error;\n        }\n        this.updateSession(session);\n    }\n    async signOut() {\n        const { error } = await this.client.auth.signOut();\n        if (error) {\n            throw error;\n        }\n        this.currentSession = null;\n    }\n    getCurrentUser() {\n        var _a, _b;\n        return (_b = (_a = this.currentSession) === null || _a === void 0 ? void 0 : _a.user) !== null && _b !== void 0 ? _b : null;\n    }\n    getAccessToken() {\n        var _a, _b;\n        return (_b = (_a = this.currentSession) === null || _a === void 0 ? void 0 : _a.access_token) !== null && _b !== void 0 ? _b : null;\n    }\n    async fetchCredentials() {\n        var _a;\n        const { data: { session }, error, } = await this.client.auth.getSession();\n        if (!session || error) {\n            throw new Error(`Could not fetch Supabase credentials: ${error}`);\n        }\n        console.debug('session expires at', session.expires_at);\n        return {\n            endpoint: this.config.powersyncUrl,\n            token: (_a = session.access_token) !== null && _a !== void 0 ? _a : '',\n        };\n    }\n    async uploadData(database) {\n        const transaction = await database.getNextCrudTransaction();\n        if (!transaction) {\n            return;\n        }\n        let lastOp = null;\n        try {\n            for (const op of transaction.crud) {\n                lastOp = op;\n                const table = this.client.from(op.table);\n                let result;\n                switch (op.op) {\n                    case UpdateType.PUT: {\n                        const record = Object.assign(Object.assign({}, op.opData), { id: op.id });\n                        result = await table.upsert(record);\n                        break;\n                    }\n                    case UpdateType.PATCH: {\n                        result = await table.update(op.opData).eq('id', op.id);\n                        break;\n                    }\n                    case UpdateType.DELETE: {\n                        result = await table.delete().eq('id', op.id);\n                        break;\n                    }\n                }\n                if (result.error) {\n                    console.error(result.error);\n                    result.error.message = `Could not update Supabase. Received error: ${result.error.message}`;\n                    throw result.error;\n                }\n            }\n            await transaction.complete();\n        }\n        catch (ex) {\n            console.debug(ex);\n            if (typeof ex.code == 'string' && FATAL_RESPONSE_CODES.some((regex) => regex.test(ex.code))) {\n                console.error('Data upload error - discarding:', lastOp, ex);\n                await transaction.complete();\n            }\n            else {\n                throw ex;\n            }\n        }\n    }\n    updateSession(session) {\n        this.currentSession = session;\n        if (!session) {\n            return;\n        }\n        this.iterateListeners((cb) => { var _a; return (_a = cb.sessionStarted) === null || _a === void 0 ? void 0 : _a.call(cb, session); });\n    }\n}\n","import { registerPlugin } from '@capacitor/core';\nconst PowerSync = registerPlugin('BlueCortexPowerSyncSupabase', {\n    web: () => import('./web').then((m) => new m.BlueCortexPowerSyncSupabaseWeb()),\n});\nexport * from './definitions';\nexport { PowerSync };\nexport { SupabaseConnector } from './SupabaseConnector';\n","import { WebPlugin } from '@capacitor/core';\nexport class BlueCortexPowerSyncSupabaseWeb extends WebPlugin {\n    async initialize(options) {\n        console.log('PowerSync Web: initialize', options);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async connect() {\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async disconnect(options) {\n        console.log('PowerSync Web: disconnect', options);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async setToken(_options) {\n        console.log('PowerSync Web: setToken (no-op on web)');\n    }\n    async execute(options) {\n        console.log('PowerSync Web: execute', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async getAll(options) {\n        console.log('PowerSync Web: getAll', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async getOptional(options) {\n        console.log('PowerSync Web: getOptional', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async watch(options) {\n        console.log('PowerSync Web: watch', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async unwatch(options) {\n        console.log('PowerSync Web: unwatch', options.watchId);\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async getSyncStatus() {\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async getVersion() {\n        throw this.unimplemented('Not implemented on web.');\n    }\n    async writeTransaction(options) {\n        console.log('PowerSync Web: writeTransaction', options.sql);\n        throw this.unimplemented('Not implemented on web.');\n    }\n}\n"],"names":["BaseObserver","createClient","UpdateType","registerPlugin","WebPlugin"],"mappings":"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"}